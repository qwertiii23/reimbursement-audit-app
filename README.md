结合 “规则引擎 + 大模型 RAG” 双层审核模式，后端需实现以下核心功能，覆盖完整审核链路：
1. 基础支撑功能
文件 / 数据上传：接收报销单（JSON / 表单）、发票图片上传，支持单文件 / 多文件批量上传；
数据解析能力：解析报销单结构化数据（JSON / 表单字段提取）、对接 OCR 服务解析发票信息（金额、发票号、开票方等）；
审核结果查询：支持按报销单 ID、用户 ID、时间范围查询审核状态（待审核 / 审核中 / 已完成）、结构化审核报告；
配置管理：规则引擎的规则 CRUD（新增 / 编辑 / 删除 / 启用禁用刚性规则）、报销制度文档管理（上传 / 更新 / 版本控制，供 RAG 检索）。
2. 核心审核功能
规则引擎校验：基于 Grule 框架执行刚性规则校验，支持规则动态加载、优先级排序，覆盖：
金额校验（如一线城市住宿费≤800 元、单日餐饮补贴上限）；
频次校验（如同一类目月报销次数≤5 次）；
发票信息校验（发票号唯一性、开票方合规性、发票状态有效）；
基础合规校验（报销单必填字段完整性、发票与报销事由关联性）。
RAG 检索与大模型交互：
报销制度预处理（文档解析→文本分片→向量嵌入→PGVector 存储）；
柔性问题检索（基于报销单上下文 + OCR 结果，从向量库检索相关报销制度）；
Prompt 构造（拼接规则校验结果、OCR 解析数据、检索到的制度条款）；
大模型 API 调用（智谱 AI / 文心一言），处理模糊发票、特殊场景判定等柔性问题；
结果结构化（解析大模型自然语言响应，转换为标准化审核结论）。
3. 数据存储与管理功能
结构化数据存储（报销单信息、审核规则、报销制度、审核报告）；
非结构化数据存储（发票图片、OCR 结果缓存）；
向量数据管理（报销制度的向量嵌入存储与检索）；
可选缓存优化（Redis 缓存高频规则、OCR 临时结果，提升响应速度）。
4. 异常处理功能
OCR 解析失败重试 / 降级处理；
大模型调用超时 / 失败 fallback 机制（如返回 “需人工复核” 标记）；
规则校验冲突处理（多规则命中时按优先级输出结果）；
数据校验异常（如报销单格式错误、发票图片损坏）的友好响应。

# 智能报销审核系统 - 开发任务清单（Go 后端）
## 一、前期准备（阶段0：第1周）
### 1. 环境与依赖搭建
- 初始化 Go 项目（go mod init），引入核心依赖（Gin、Grule、MySQL 驱动、UUID 工具、BASE64 编码库）
- 搭建开发环境（MySQL 5.6、本地文件存储/MinIO、Postman 接口测试工具）
- 配置多环境配置文件（dev/prod，含数据库连接、API 密钥、存储路径等）

### 2. 设计文档完善
- 编写详细接口文档（RESTful 风格，含路径、方法、请求/响应参数、状态码）
- 确认数据库表结构脚本（MySQL 5.6 适配版），执行初始化 SQL
- 定义核心结构体（报销单、发票、规则、审核报告等），统一数据格式

## 二、核心功能开发（阶段1：第2-4周）
### 模块1：上传模块（单文件上传）✅
- 1.1 报销单上传接口开发（支持 JSON 格式文件+表单录入）✅
  - 校验报销单必填字段（user_id、user_name、total_amount、category、reason）
  - 生成报销单 UUID，存储核心信息至 reimbursements 表
- 1.2 发票单文件上传接口开发（支持 JPG/PNG/PDF，单文件≤10MB）✅
  - 校验文件格式与大小，生成发票 UUID
  - 存储发票图片至本地/MinIO，记录 image_path 至 invoices 表
- 1.3 报销单与发票关联逻辑开发 ✅
  - 上传发票时绑定 reimbursement_id，确保一对多关联关系
  - 返回上传结果（upload_id、文件存储路径、关联状态）

### 模块2：数据解析模块（基础解析）✅
- 2.1 OCR 基础解析集成（必选字段）✅
  - 对接 OCR 服务 API，传入发票图片路径
  - 解析发票核心信息（发票号、发票类型、开票方、开票日期、金额、税额、价税合计）
  - 存储 OCR 解析结果至 invoices.ocr_text，标记 is_valid 状态

### 模块3：规则引擎模块（基础规则管理与校验）
- 3.1 规则管理接口（新增/查询）✅
  - 新增规则接口：校验 rule_code 唯一性，存储规则信息至 audit_rules 表
  - 查询规则接口：支持按 rule_code、category、status 筛选，返回规则列表
- 3.2 Grule 引擎集成 ✅
  - 初始化 Grule 引擎，加载数据库中启用的规则
  - 编写规则编译逻辑，支持动态加载规则
- 3.3 基础刚性规则校验逻辑
  - 金额校验：按城市级别+报销类目校验金额上限（如一线城市住宿费≤800元）
  - 发票唯一性校验：查询 invoices 表，避免重复报销
  - 返回校验结果（passed 状态、违规规则列表）

### 模块4：审核流程模块（手动触发审核）
- 4.1 手动触发审核接口开发
  - 接收 upload_id/reimbursement_id，触发规则校验流程
  - 存储审核任务状态至 audit_tasks 表（初始状态 pending）
- 4.2 审核结果合并逻辑
  - 规则校验通过→结论暂定为“待 RAG 审核”（阶段1简化为“通过”）
  - 规则校验未通过→结论“驳回”，整合违规原因
- 4.3 审核任务状态更新
  - 审核完成后更新 audit_tasks 表（status=completed，progress=100）

### 模块5：审核结果模块（基础查询与报告）
- 5.1 审核结果查询接口（按报销单 ID）
  - 关联查询 reimbursements、invoices、audit_reports 表
  - 返回报销单基础信息、发票列表、规则校验结果
- 5.2 基础审核报告生成（JSON 格式）
  - 拼接报销单信息、发票信息、规则校验结果
  - 存储报告至 audit_reports 表

### 模块6：核心链路联调与 Bug 修复
- 6.1 跨模块联调（上传→解析→审核→查询）
  - 测试单文件上传→解析→手动审核→结果查询全流程
  - 修复字段映射错误、关联关系异常等问题
- 6.2 基础 Bug 修复
  - 处理 OCR 解析失败、规则语法错误、数据库连接异常等场景
  - 优化接口响应格式，统一错误提示

## 三、功能完善（阶段2：第5-8周）
### 模块1：上传模块（批量上传与记录查询）
- 1.1 批量发票上传接口开发（单次≤20张）
  - 支持多文件选择，批量生成发票 UUID
  - 批量绑定 reimbursement_id，批量存储至 invoices 表
- 1.2 压缩包上传接口（1个报销单文件+N个发票文件）
  - 解析压缩包，提取报销单与发票文件
  - 自动关联报销单与发票，批量上传
- 1.3 上传进度展示逻辑
  - 计算文件上传进度（百分比），通过接口返回给前端
- 1.4 上传记录查询接口
  - 支持按上传时间、user_id、上传状态（成功/失败）筛选
  - 返回上传记录列表（upload_id、reimbursement_id、上传时间、状态）

### 模块2：数据解析模块（完善解析能力）
- 2.1 OCR 可选字段解析
  - 解析发票代码、购买方名称、商品名称等可选字段
  - 补充存储至 invoices 表，缺失时默认空字符串
- 2.2 OCR 解析失败处理
  - 解析失败时标记 ocr_error_msg，返回“解析失败”提示
  - 支持重新上传发票图片或手动录入发票核心信息
- 2.3 报销单与发票金额一致性校验
  - 校验发票价税合计总和与报销单 total_amount 是否一致
  - 不一致时返回警告，需人工确认（阶段2简化为标记异常）

### 模块3：规则引擎模块（规则全生命周期管理）
- 3.1 规则编辑/禁用/删除接口
  - 编辑规则：支持修改规则名称、内容、优先级、状态（需重新编译）
  - 禁用/删除规则：禁用规则状态设为 disabled，删除未启用规则
- 3.2 规则优先级排序逻辑
  - 规则执行时按 priority 降序排序（1最高）
  - 高优先级规则先执行，结果权重高于低优先级
- 3.3 规则操作日志记录
  - 记录规则新增/编辑/禁用/删除操作（操作人、时间、修改前后内容）
  - 存储至 rule_operation_logs 表（新增表）

### 模块4：RAG 模块（大模型相关功能）
- 4.1 报销制度上传与解析
  - 制度上传接口：支持 PDF/Word/TXT 格式，存储至 reimbursement_documents 表
  - 文档解析逻辑：提取纯文本，按500字分片，生成 chunk_id
- 4.2 文本向量嵌入与存储
  - 集成向量嵌入工具（sentence-transformers-go）
  - 将分片文本转换为向量数组→JSON→BASE64 编码，存储至 embedding 字段
- 4.3 RAG 检索逻辑（MySQL 文本匹配模拟）
  - 根据报销单类目、事由、城市级别，关键词匹配 chunk_content
  - 返回 Top3 相关分片内容
- 4.4 大模型 API 对接与 Prompt 构造
  - 集成智谱 AI/文心一言 API，编写客户端调用逻辑
  - 拼接规则校验结果、OCR 信息、检索分片，生成标准化 Prompt
- 4.5 大模型结果结构化解析
  - 解析大模型自然语言响应，转换为 JSON 格式（compliant、reason、suggestion）
  - 解析失败→标记“需人工复核”

### 模块5：审核流程模块（自动触发审核）
- 5.1 自动触发审核逻辑
  - 报销单+发票上传解析完成后，自动触发审核流程（无需手动调用）
  - 更新 audit_tasks 表（status=processing，progress=50）
- 5.2 完整审核流程编排（规则校验→RAG 检索→大模型调用）
  - 规则校验→RAG 检索→Prompt 构造→大模型调用→结果结构化
  - 每步更新 audit_tasks 表 progress（规则校验50%→RAG 检索80%→完成100%）
- 5.3 审核任务跟踪接口
  - 支持按 task_id/reimbursement_id 查询任务状态与进度
  - 返回 task_status、progress、error_msg（失败时）

### 模块6：审核结果模块（多维度查询与报告下载）
- 6.1 多维度审核结果查询接口
  - 支持按 user_id、审核状态、时间范围、最终结论筛选
  - 分页返回查询结果，支持排序（按审核时间倒序）
- 6.2 审核报告 PDF 下载
  - 集成 PDF 生成库（如 github.com/jung-kurt/gofpdf）
  - 按标准化模板生成 PDF 报告，提供下载接口
- 6.3 报告打印功能支持
  - 优化报告格式，适配打印需求（去除冗余信息）

### 模块7：功能联调与 Bug 修复
- 7.1 自动化审核流程联调
  - 测试批量上传→自动解析→自动审核→报告下载全流程
  - 修复 RAG 检索不准确、大模型调用超时、结果结构化失败等问题
- 7.2 边缘场景适配
  - 处理发票图片模糊、报销制度无相关条款、大模型 API 调用失败等场景
  - 优化接口响应速度，减少冗余查询

## 四、优化与扩展（阶段3：第9-11周）
### 模块1：基础设施层优化（缓存集成）
- 1.1 Redis 缓存集成
  - 初始化 Redis 客户端，配置连接池
  - 缓存 OCR 结果（key=ocr:{invoice_no}，过期1小时）
  - 缓存高频规则（key=rule:enabled，过期5分钟）
- 1.2 缓存命中率统计与优化
  - 记录缓存命中次数，优化缓存key设计
  - 缓存失效时自动降级查询数据库

### 模块2：审核流程模块（人工复核）
- 2.1 人工复核列表查询接口
  - 筛选 audit_reports 表中 final_conclusion=manual 的单据
  - 返回报销单信息、发票列表、规则校验结果、大模型原始响应
- 2.2 人工复核结论录入接口
  - 接收复核结论（通过/驳回）、复核理由
  - 更新 audit_reports 表 final_conclusion、final_reason
- 2.3 复核日志记录
  - 存储复核人、复核时间、复核前后结论至 manual_review_logs 表（新增表）

### 模块3：日志模块（操作日志）
- 3.1 操作日志接口开发
  - 记录用户操作（上传、查询、触发审核）：操作人、时间、IP、结果
  - 记录配置操作（规则/制度新增/编辑）：操作人、时间、修改内容
- 3.2 操作日志查询接口
  - 支持按操作人、操作类型、时间范围筛选
  - 分页返回日志列表

### 模块4：统计模块（基础统计分析）
- 4.1 审核效率统计接口
  - 按日/周/月统计审核单据总数、通过数、驳回数、人工复核数
  - 计算平均审核耗时（audit_time - upload_time）
- 4.2 违规统计接口
  - 按违规规则、报销类目统计违规单据数、违规金额
  - 返回统计结果（JSON 格式，供前端可视化）
- 4.3 统计结果导出接口（Excel 格式）
  - 集成 Excel 生成库（如 github.com/xuri/excelize/v2）
  - 支持统计结果导出

### 模块5：存储模块扩展（MinIO 集成）
- 5.1 MinIO 客户端集成
  - 替换本地文件存储，适配 MinIO 分布式存储
  - 开发文件上传/下载/删除接口，兼容 MinIO
- 5.2 文件访问权限控制
  - 生成临时访问 URL，限制访问时长
  - 仅授权用户访问自己的报销文件

### 模块6：性能优化与容错机制
- 6.1 性能压测与瓶颈优化
  - 对核心接口（上传、审核、查询）进行压测
  - 优化 SQL 索引（新增联合索引）、减少数据库查询次数
- 6.2 容错机制优化
  - 大模型 API 调用：超时设置30s，支持3次重试，失败降级为人工复核
  - 数据库异常：实现重连机制，避免系统崩溃
  - 文件上传失败：支持断点续传（简化版为重新上传）

## 五、系统测试与修复（阶段4：第12周）
### 1. 功能全面测试
- 1.1 黑盒测试：覆盖所有接口，验证功能完整性
- 1.2 接口自动化测试：编写测试用例，验证接口响应格式与逻辑
- 1.3 边缘场景测试：异常文件上传、网络中断、API 调用失败等

### 2. Bug 修复与优化
- 2.1 高优先级 Bug 修复：功能异常、数据一致性问题
- 2.2 低优先级优化：接口响应速度、日志清晰度、错误提示友好度

### 3. 交付物整理
- 3.1 代码整理：格式化代码，补充注释，清理冗余代码
- 3.2 文档完善：更新接口文档、部署手册、测试报告
- 3.3 环境配置导出：整理开发/生产环境配置文件


reimbursement-audit/
├── cmd/                          // 程序入口
│   └── api/                      // API服务入口
│       └── main.go               // 初始化配置、启动Gin服务
├── internal/                     // 私有核心代码（不可外部导入）
│   ├── api/                      // API层：路由、控制器、请求响应
│   │   ├── handler/              // 接口处理器（控制器）
│   │   │   ├── upload_handler.go // 上传（报销单/发票）处理
│   │   │   ├── audit_handler.go  // 审核触发处理
│   │   │   ├── query_handler.go // 结果查询处理
│   │   │   └── rule_handler.go   // 规则管理处理
│   │   ├── middleware/           // 中间件
│   │   │   ├── logger.go         // 日志中间件
│   │   │   ├── ratelimit.go      // 限流中间件
│   │   │   └── auth.go           // 认证中间件（可选）
│   │   ├── request/              // 请求结构体+参数校验
│   │   │   ├── upload_request.go
│   │   │   ├── audit_request.go
│   │   │   └── rule_request.go
│   │   ├── response/             // 响应结构体+统一返回
│   │   │   ├── response.go       // 统一响应格式
│   │   │   ├── code.go           // 错误码定义
│   │   │   └── report.go         // 审核报告结构体
│   │   └── router/               // 路由注册
│   │       └── router.go         // 绑定接口与处理器
│   ├── config/                   // 配置管理
│   │   ├── config.go             // 配置结构体（数据库、大模型、存储等）
│   │   └── loader.go             // 配置加载（yaml+环境变量）
│   ├── domain/                   // 领域层：核心业务逻辑
│   │   ├── reimbursement/        // 报销单领域
│   │   │   ├── service.go        // 审核流程编排逻辑
│   │   │   ├── parser.go         // 报销单/OCR解析逻辑
│   │   │   └── model.go          // 领域模型（报销单、审核结果）
│   │   ├── rule/                 // 规则引擎领域
│   │   │   ├── service.go        // 规则校验逻辑
│   │   │   ├── grule_engine.go   // Grule引擎封装
│   │   │   └── model.go          // 规则模型（规则定义、优先级）
│   │   └── rag/                  // RAG大模型领域
│   │       ├── service.go        // RAG+大模型交互逻辑
│   │       ├── document_processor.go // 报销制度文档处理（解析+分片）
│   │       ├── vector_store.go   // PGVector检索封装
│   │       ├── prompt_builder.go // Prompt构造逻辑
│   │       └── model.go          // RAG相关模型（向量数据、Prompt）
│   ├── infra/                    // 基础设施层：外部依赖实现
│   │   ├── storage/              // 存储实现
│   │   │   ├── postgres/         // PostgreSQL客户端（含PGVector）
│   │   │   │   ├── client.go     // 数据库连接封装
│   │   │   │   ├── migration/    // 数据库迁移文件（表结构初始化）
│   │   │   │   └── repo/         // 数据访问接口实现
│   │   │   │       ├── reimbursement_repo.go
│   │   │   │       ├── rule_repo.go
│   │   │   │       └── document_repo.go
│   │   │   ├── redis/            // Redis客户端（可选）
│   │   │   │   └── client.go     // 缓存操作封装
│   │   │   └── file/             // 文件存储实现
│   │   │       ├── local.go      // 本地文件存储
│   │   │       └── minio.go      // MinIO存储（可选）
│   │   ├── external/             // 外部服务客户端
│   │   │   ├── ocr_client.go     // OCR服务对接（第三方/OCR SDK）
│   │   │   └── llm_client.go     // 大模型API客户端（智谱/文心一言）
│   │   └── repo/                 // 仓储层接口定义
│   │       ├── reimbursement_repo.go
│   │       ├── rule_repo.go
│   │       └── document_repo.go
│   ├── pkg/                      // 内部通用工具
│   │   ├── logger/               // 日志封装（zap）
│   │   ├── validator/            // 自定义参数校验
│   │   ├── embedder/             // 向量嵌入工具（如sentence-transformers-go）
│   │   ├── errno/                // 自定义错误类型
│   │   └── trace/                // 链路追踪（可选，jaeger）
│   └── server/                   // 服务启动配置
│       └── http.go               // Gin服务配置（端口、超时、中间件）
├── pkg/                          // 公共库（可外部导入，本项目暂用内部pkg）
├── api/                          // API定义
│   └── swagger/                  // Swagger文档（接口注释生成）
├── configs/                      // 配置文件
│   ├── dev/
│   │   └── app.yaml              // 开发环境配置（数据库、大模型API密钥等）
│   └── prod/
│       └── app.yaml              // 生产环境配置
├── scripts/                      // 脚本
│   ├── migrate.sh                // 数据库迁移脚本
│   ├── build.sh                  // 编译脚本
│   └── start.sh                  // 启动脚本
├── test/                         // 测试用例
│   ├── unit/                     // 单元测试（领域层核心逻辑）
│   └── integration/              // 集成测试（接口+数据库）
├── docs/                         // 项目文档（架构设计、规则说明、API文档）
├── go.mod                        // Go Module依赖
├── go.sum
├── Makefile                      // 构建/测试/迁移命令封装
└── README.md                     // 项目说明
